<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ansible Playbook Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #050810;
      --panel: #0f172a;
      --panel-alt: #020617;
      --border: #1f2937;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.12);
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --radius-lg: 14px;
      --radius-md: 10px;
      --radius-sm: 6px;
      --shadow-soft: 0 18px 45px rgba(15,23,42,0.9);
      --shadow-subtle: 0 10px 30px rgba(15,23,42,0.55);
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      background: radial-gradient(circle at top, #020617 0, #020617 180px, #020617 200px, #000 500px);
      background-color: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .app {
      max-width: 1440px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-end;
      padding: 14px 18px;
      background: linear-gradient(135deg, #020617 0, #020617 40%, #020617 65%, #020617 100%);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.24);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .app-header::before {
      content: "";
      position: absolute;
      inset: -120px;
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,0.32) 0, transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(129,140,248,0.26) 0, transparent 50%);
      mix-blend-mode: screen;
      opacity: 0.6;
      pointer-events: none;
    }

    .app-header-main {
      position: relative;
      z-index: 1;
    }

    .app-title {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      color: var(--text-muted);
      background: rgba(15,23,42,0.7);
    }

    .app-subtitle {
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-muted);
      max-width: 640px;
    }

    .app-header-controls {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
    }

    .format-toggle {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.35);
    }

    .format-toggle button {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .format-toggle button.active {
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 500;
    }

    .format-toggle button span.icon {
      font-size: 13px;
    }

    .hint-chip {
      font-size: 10px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
      opacity: 0.9;
    }

    .hint-chip .dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(56,189,248,0.9);
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(260px, 320px) minmax(260px, 380px) minmax(360px, 1fr);
      gap: 14px;
      align-items: flex-start;
    }

    @media (max-width: 1080px) {
      .grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 840px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.95) 0, #020617 60%, #020617 100%);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(15,23,42,0.95);
      box-shadow: var(--shadow-subtle);
      padding: 12px 14px;
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15,23,42,0.9) 0, transparent 55%);
      opacity: 0.9;
      pointer-events: none;
    }

    .panel-inner {
      position: relative;
      z-index: 1;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .panel-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
    }

    .badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.55);
      color: var(--text-muted);
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    .field-label-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .field label {
      font-size: 12px;
      color: #d1d5db;
    }

    .field .hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    select,
    input[type="text"],
    input[type="number"] {
      background: rgba(15,23,42,0.9);
      border-radius: var(--radius-md);
      border: 1px solid rgba(31,41,55,0.95);
      padding: 6px 8px;
      font-size: 12px;
      color: var(--text);
      outline: none;
      width: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    select:focus,
    input[type="text"]:focus,
    input[type="number"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.45);
    }

    .input-inline {
      display: flex;
      gap: 6px;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .tiny-pill {
      font-size: 10px;
      padding: 2px 5px;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      color: var(--text-muted);
      background: rgba(15,23,42,0.9);
    }

    .button-row {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    button {
      font-family: inherit;
    }

    .btn {
      border-radius: 999px;
      font-size: 12px;
      padding: 6px 10px;
      border: 1px solid rgba(31,41,55,0.95);
      background: rgba(15,23,42,0.95);
      color: var(--text);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.12s ease;
    }

    .btn-primary {
      border-color: rgba(56,189,248,0.85);
      background: radial-gradient(circle at top, rgba(56,189,248,0.35) 0, rgba(8,47,73,0.9) 60%, #020617 100%);
      color: #e0f2fe;
    }

    .btn:hover {
      transform: translateY(-0.5px);
      border-color: rgba(148,163,184,0.9);
    }

    .btn-primary:hover {
      border-color: rgba(56,189,248,1);
      box-shadow: 0 0 18px rgba(56,189,248,0.55);
    }

    .btn-ghost {
      border-style: dashed;
      border-color: rgba(55,65,81,0.9);
      color: var(--text-muted);
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 11px;
    }

    .btn-icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      padding: 0;
      justify-content: center;
    }

    .btn-icon span {
      font-size: 14px;
    }

    .code-panel {
      background: linear-gradient(145deg, #020617 0, #020617 40%, #020617 100%);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(15,23,42,0.95);
      box-shadow: var(--shadow-soft);
      padding: 10px 12px;
      position: relative;
      overflow: hidden;
    }

    .code-panel::before {
      content: "";
      position: absolute;
      inset: -150px;
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,0.18) 0, transparent 50%),
        radial-gradient(circle at 100% 100%, rgba(129,140,248,0.18) 0, transparent 50%);
      opacity: 0.9;
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .code-panel-inner {
      position: relative;
      z-index: 1;
    }

    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }

    .code-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .code-header-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
    }

    .code-meta {
      font-size: 10px;
      color: var(--text-muted);
    }

    .code-actions {
      display: flex;
      gap: 6px;
    }

    pre {
      margin: 0;
      padding: 10px 10px;
      border-radius: var(--radius-md);
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(31,41,55,0.95);
      font-family: var(--font-mono);
      font-size: 11px;
      color: #e5e7eb;
      max-height: 420px;
      overflow: auto;
      white-space: pre;
    }

    .command-bar {
      margin-top: 6px;
      padding: 6px 8px;
      border-radius: var(--radius-md);
      background: rgba(15,23,42,0.9);
      border: 1px dashed rgba(55,65,81,0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .command-text {
      font-family: var(--font-mono);
      font-size: 11px;
      color: #9ca3af;
      overflow-x: auto;
      white-space: nowrap;
    }

    .status-line {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(74,222,128,0.95);
      box-shadow: 0 0 10px rgba(74,222,128,0.75);
    }

    .status-dot.error {
      background: var(--danger);
      box-shadow: 0 0 10px rgba(248,113,113,0.85);
    }

    .error-text {
      color: var(--danger);
    }
  </style>
</head>
<body>
<div class="app">
  <header class="app-header">
    <div class="app-header-main">
      <div class="app-title">
        <span>ANSIBLE PLAYBOOK GENERATOR</span>
        <span class="pill">Multi-Cloud ¬∑ Scripts ¬∑ Playbooks</span>
      </div>
      <p class="app-subtitle">
        Pick platform ‚Üí scenario ‚Üí inputs. The generator builds a ready-to-run Ansible playbook and can emit YAML or JSON.
        Platforms include AWS, Azure, Google Cloud, Oracle, VMware, plus generic Linux/Windows config.
      </p>
    </div>
    <div class="app-header-controls">
      <div class="format-toggle" id="formatToggle">
        <button type="button" data-format="yaml" class="active">
          <span class="icon">üßæ</span> YAML
        </button>
        <button type="button" data-format="json">
          <span class="icon">{"{}"}</span> JSON
        </button>
      </div>
      <div class="hint-chip">
        <span class="dot"></span>
        <span>All templates are data-driven; extend in <code>SCENARIO_DEFS</code>.</span>
      </div>
    </div>
  </header>

  <main class="grid">
    <!-- PLATFORM / SCENARIO PICKER -->
    <section class="panel">
      <div class="panel-inner">
        <div class="panel-header">
          <div class="panel-title">Platform &amp; Scenario</div>
          <div class="badge">Step 1</div>
        </div>

        <div class="field">
          <div class="field-label-row">
            <label for="platformSelect">Target Platform / Provider</label>
            <span class="hint">Cloud or on-prem target</span>
          </div>
          <select id="platformSelect">
            <!-- populated by JS -->
          </select>
          <div class="pill-row">
            <span class="tiny-pill">AWS</span>
            <span class="tiny-pill">Azure</span>
            <span class="tiny-pill">Google Cloud</span>
            <span class="tiny-pill">Oracle Cloud</span>
            <span class="tiny-pill">VMware vSphere</span>
            <span class="tiny-pill">Linux</span>
            <span class="tiny-pill">Windows</span>
          </div>
        </div>

        <div class="field">
          <div class="field-label-row">
            <label for="scenarioSelect">Scenario / Blueprint</label>
            <span class="hint">What are we trying to do?</span>
          </div>
          <select id="scenarioSelect">
            <!-- populated by JS -->
          </select>
        </div>

        <div class="field">
          <div class="field-label-row">
            <label for="hostsInput">Inventory hosts pattern</label>
            <span class="hint">From your <code>inventory.yml</code></span>
          </div>
          <input id="hostsInput" type="text" value="all" />
        </div>

        <div class="field">
          <div class="field-label-row">
            <label for="filenameInput">Suggested playbook filename</label>
            <span class="hint">Used in CLI hint</span>
          </div>
          <input id="filenameInput" type="text" value="playbook_generated.yml" />
        </div>

        <div class="button-row">
          <button type="button" class="btn btn-ghost btn-sm" id="resetButton">Reset</button>
        </div>
      </div>
    </section>

    <!-- PARAMETER FORM -->
    <section class="panel">
      <div class="panel-inner">
        <div class="panel-header">
          <div class="panel-title">Parameters &amp; Options</div>
          <div class="badge">Step 2</div>
        </div>

        <div id="paramsArea">
          <!-- dynamic inputs rendered here -->
        </div>

        <div class="button-row">
          <button type="button" class="btn btn-primary" id="generateButton">
            <span>‚öôÔ∏è</span>
            <span>Generate Playbook</span>
          </button>
        </div>
      </div>
    </section>

    <!-- GENERATED CODE -->
    <section class="code-panel">
      <div class="code-panel-inner">
        <div class="code-header">
          <div class="code-header-left">
            <div class="code-header-title">Generated Ansible Code</div>
            <div class="code-meta" id="codeMeta">
              Waiting for input‚Ä¶
            </div>
          </div>
          <div class="code-actions">
            <button type="button" class="btn btn-sm" id="downloadButton">
              ‚¨áÔ∏è Download
            </button>
            <button type="button" class="btn btn-icon" id="copyButton" title="Copy to clipboard">
              <span>üìã</span>
            </button>
          </div>
        </div>

        <pre id="outputPre"># Select a platform & scenario, adjust parameters, then click ‚ÄúGenerate Playbook‚Äù.</pre>

        <div class="command-bar">
          <div class="command-text" id="commandHint">
            ansible-playbook -i inventory.yml playbook_generated.yml
          </div>
          <button type="button" class="btn btn-sm btn-ghost" id="copyCommandButton">
            Copy command
          </button>
        </div>

        <div class="status-line" id="statusLine">
          <span class="status-dot"></span>
          <span>Idle ‚Äî no errors.</span>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  // -----------------------
  // Helper option lists for dropdowns
  // -----------------------
  const AWS_REGIONS = [
    "us-east-1", "us-east-2", "us-west-1", "us-west-2",
    "eu-central-1", "eu-west-1", "eu-west-2",
    "ap-southeast-1", "ap-southeast-2", "ap-northeast-1"
  ];

  const AZURE_LOCATIONS = [
    "eastus", "eastus2", "westus", "westeurope",
    "northeurope", "uksouth", "centralus"
  ];

  const GCP_ZONES = [
    "us-central1-a", "us-central1-b",
    "us-east1-b", "us-east1-c",
    "europe-west1-b", "europe-west1-c"
  ];

  const BOOL_OPTIONS = [
    { value: "true", label: "true" },
    { value: "false", label: "false" }
  ];

  // -----------------------
  // Data model: platforms & scenarios
  // control: "select" => render dropdown with options[]
  // -----------------------
  const SCENARIO_DEFS = {
    aws: {
      label: "Amazon Web Services (AWS)",
      scenarios: {
        ec2_instance: {
          label: "Provision EC2 instance",
          description: "Create or update an EC2 instance with an attached security group.",
          inputs: [
            {
              id: "aws_region",
              label: "AWS region",
              control: "select",
              options: AWS_REGIONS.map(r => ({ value: r, label: r })),
              default: "us-east-1",
              hint: "Target region"
            },
            { id: "instance_name", label: "Instance Name tag", type: "text", default: "web-01", hint: "Name tag value" },
            {
              id: "instance_type",
              label: "Instance type",
              control: "select",
              options: [
                "t3.micro","t3.small","t3.medium",
                "t3a.micro","t3a.small","t3a.medium"
              ].map(v => ({ value: v, label: v })),
              default: "t3.small",
              hint: "Size"
            },
            { id: "ami_id", label: "AMI ID", type: "text", default: "ami-xxxxxxxx", hint: "From your AMI catalog" },
            { id: "key_name", label: "SSH key name", type: "text", default: "default", hint: "Must exist in region" },
            { id: "vpc_subnet_id", label: "Subnet ID", type: "text", default: "subnet-xxxx", hint: "Target subnet in VPC" },
            { id: "security_group_name", label: "Security group name", type: "text", default: "sg-web", hint: "Created if absent" },
            { id: "allowed_http_cidr", label: "HTTP allowed CIDR", type: "text", default: "0.0.0.0/0", hint: "Restrict in real environments" }
          ],
          buildPlay: (vals, hosts) => {
            return [
              {
                name: "Provision EC2 instance",
                hosts,
                become: false,
                gather_facts: false,
                vars: {
                  aws_region: vals.aws_region,
                  instance_name: vals.instance_name,
                  instance_type: vals.instance_type,
                  ami_id: vals.ami_id,
                  key_name: vals.key_name,
                  vpc_subnet_id: vals.vpc_subnet_id,
                  security_group_name: vals.security_group_name,
                  allowed_http_cidr: vals.allowed_http_cidr
                },
                tasks: [
                  {
                    name: "Ensure security group exists",
                    "amazon.aws.ec2_security_group": {
                      name: "{{ security_group_name }}",
                      description: "Web security group",
                      region: "{{ aws_region }}",
                      rules: [
                        { proto: "tcp", from_port: 22, to_port: 22, cidr_ip: "0.0.0.0/0" },
                        { proto: "tcp", from_port: 80, to_port: 80, cidr_ip: "{{ allowed_http_cidr }}" }
                      ]
                    }
                  },
                  {
                    name: "Launch or update EC2 instance",
                    "amazon.aws.ec2_instance": {
                      name: "{{ instance_name }}",
                      region: "{{ aws_region }}",
                      image_id: "{{ ami_id }}",
                      instance_type: "{{ instance_type }}",
                      key_name: "{{ key_name }}",
                      vpc_subnet_id: "{{ vpc_subnet_id }}",
                      security_group: "{{ security_group_name }}",
                      wait: true
                    }
                  }
                ]
              }
            ];
          }
        },
        s3_bucket: {
          label: "Create S3 bucket",
          description: "Create an S3 bucket with versioning and basic encryption.",
          inputs: [
            {
              id: "aws_region",
              label: "AWS region",
              control: "select",
              options: AWS_REGIONS.map(r => ({ value: r, label: r })),
              default: "us-east-1",
              hint: "Bucket home region"
            },
            { id: "bucket_name", label: "Bucket name", type: "text", default: "court-archive-bucket", hint: "Globally unique name" },
            {
              id: "enable_versioning",
              label: "Enable versioning",
              control: "select",
              options: BOOL_OPTIONS,
              default: "true",
              hint: "true / false"
            },
            {
              id: "sse_algorithm",
              label: "SSE algorithm",
              control: "select",
              options: [
                { value: "AES256", label: "AES256" },
                { value: "aws:kms", label: "aws:kms" }
              ],
              default: "AES256",
              hint: "Encryption type"
            }
          ],
          buildPlay: (vals, hosts) => {
            return [
              {
                name: "Create S3 bucket",
                hosts,
                become: false,
                gather_facts: false,
                vars: {
                  aws_region: vals.aws_region,
                  bucket_name: vals.bucket_name,
                  enable_versioning: vals.enable_versioning === "true",
                  sse_algorithm: vals.sse_algorithm
                },
                tasks: [
                  {
                    name: "Create or ensure S3 bucket exists",
                    "amazon.aws.s3_bucket": {
                      name: "{{ bucket_name }}",
                      state: "present",
                      region: "{{ aws_region }}"
                    }
                  },
                  {
                    name: "Configure S3 bucket versioning",
                    "amazon.aws.s3_bucket": {
                      name: "{{ bucket_name }}",
                      region: "{{ aws_region }}",
                      versioning: { Status: "{{ 'Enabled' if enable_versioning else 'Suspended' }}" }
                    }
                  },
                  {
                    name: "Configure default encryption",
                    "amazon.aws.s3_bucket": {
                      name: "{{ bucket_name }}",
                      region: "{{ aws_region }}",
                      encryption_configuration: {
                        Rules: [
                          {
                            ApplyServerSideEncryptionByDefault: {
                              SSEAlgorithm: "{{ sse_algorithm }}"
                            }
                          }
                        ]
                      }
                    }
                  }
                ]
              }
            ];
          }
        },
        rds_instance: {
          label: "Provision RDS instance",
          description: "Create an RDS instance for a relational database.",
          inputs: [
            {
              id: "aws_region",
              label: "AWS region",
              control: "select",
              options: AWS_REGIONS.map(r => ({ value: r, label: r })),
              default: "us-east-1",
              hint: "DB region"
            },
            { id: "db_identifier", label: "DB identifier", type: "text", default: "court-db-01", hint: "Unique RDS identifier" },
            {
              id: "engine",
              label: "Engine",
              control: "select",
              options: [
                { value: "postgres", label: "PostgreSQL" },
                { value: "mysql", label: "MySQL" },
                { value: "mariadb", label: "MariaDB" }
              ],
              default: "postgres",
              hint: "DB engine"
            },
            { id: "engine_version", label: "Engine version", type: "text", default: "15", hint: "e.g. 15, 14.10" },
            { id: "instance_class", label: "Instance class", type: "text", default: "db.t3.medium", hint: "Size" },
            { id: "db_username", label: "Master username", type: "text", default: "dbadmin", hint: "Admin user" },
            { id: "db_name", label: "Database name", type: "text", default: "court", hint: "Initial DB name" },
            {
              id: "allocated_storage",
              label: "Allocated storage (GiB)",
              type: "number",
              default: "50",
              hint: "Size in GiB"
            }
          ],
          buildPlay: (vals, hosts) => {
            return [
              {
                name: "Provision RDS instance",
                hosts,
                become: false,
                gather_facts: false,
                vars: {
                  aws_region: vals.aws_region,
                  db_identifier: vals.db_identifier,
                  engine: vals.engine,
                  engine_version: vals.engine_version,
                  instance_class: vals.instance_class,
                  db_username: vals.db_username,
                  db_name: vals.db_name,
                  allocated_storage: parseInt(vals.allocated_storage, 10)
                },
                tasks: [
                  {
                    name: "Create RDS instance",
                    "amazon.aws.rds_instance": {
                      region: "{{ aws_region }}",
                      db_instance_identifier: "{{ db_identifier }}",
                      engine: "{{ engine }}",
                      engine_version: "{{ engine_version }}",
                      db_instance_class: "{{ instance_class }}",
                      master_username: "{{ db_username }}",
                      master_user_password: "{{ db_master_password | default('CHANGE_ME') }}",
                      allocated_storage: "{{ allocated_storage }}",
                      db_name: "{{ db_name }}",
                      state: "present"
                    }
                  }
                ]
              }
            ];
          }
        },
        iam_role: {
          label: "Create IAM role for EC2",
          description: "Create an IAM role and instance profile for EC2 with a basic policy.",
          inputs: [
            { id: "role_name", label: "Role name", type: "text", default: "ec2-ssm-role", hint: "IAM role name" },
            { id: "profile_name", label: "Instance profile name", type: "text", default: "ec2-ssm-profile", hint: "Profile name" },
            {
              id: "attach_ssm_policy",
              label: "Attach AmazonSSMManagedInstanceCore",
              control: "select",
              options: BOOL_OPTIONS,
              default: "true",
              hint: "true / false"
            }
          ],
          buildPlay: (vals, hosts) => {
            return [
              {
                name: "Create IAM role for EC2",
                hosts,
                become: false,
                gather_facts: false,
                vars: {
                  role_name: vals.role_name,
                  profile_name: vals.profile_name,
                  attach_ssm_policy: vals.attach_ssm_policy === "true"
                },
                tasks: [
                  {
                    name: "Create IAM role",
                    "amazon.aws.iam_role": {
                      name: "{{ role_name }}",
                      assume_role_policy_document: {
                        Version: "2012-10-17",
                        Statement: [
                          {
                            Effect: "Allow",
                            Principal: { Service: "ec2.amazonaws.com" },
                            Action: "sts:AssumeRole"
                          }
                        ]
                      }
                    }
                  },
                  {
                    name: "Create instance profile",
                    "amazon.aws.iam_instance_profile": {
                      name: "{{ profile_name }}",
                      state: "present",
                      roles: ["{{ role_name }}"]
                    }
                  },
                  {
                    name: "Attach SSM managed policy",
                    "amazon.aws.iam_managed_policy": {
                      state: "{{ 'present' if attach_ssm_policy else 'absent' }}",
                      policy_arn: "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore",
                      iam_type: "role",
                      iam_name: "{{ role_name }}"
                    }
                  }
                ]
              }
            ];
          }
        }
      }
    },

    azure: {
      label: "Microsoft Azure",
      scenarios: {
        vm_linux: {
          label: "Provision Azure Linux VM",
          description: "Create a Linux VM, NIC and basic security group.",
          inputs: [
            {
              id: "azure_location",
              label: "Azure location",
              control: "select",
              options: AZURE_LOCATIONS.map(l => ({ value: l, label: l })),
              default: "eastus",
              hint: "Region"
            },
            { id: "resource_group", label: "Resource group", type: "text", default: "rg-ansible-demo", hint: "Existing or to create" },
            { id: "vm_name", label: "VM name", type: "text", default: "vm-linux-01", hint: "Name of the VM" },
            { id: "vm_size", label: "VM size", type: "text", default: "Standard_B2s", hint: "e.g. Standard_B2s" },
            { id: "admin_username", label: "Admin username", type: "text", default: "azureuser", hint: "SSH user" }
          ],
          buildPlay: (vals, hosts) => {
            return [
              {
                name: "Provision Azure Linux VM",
                hosts,
                become: false,
                gather_facts: false,
                vars: {
                  azure_location: vals.azure_location,
                  resource_group: vals.resource_group,
                  vm_name: vals.vm_name,
                  vm_size: vals.vm_size,
                  admin_username: vals.admin_username
                },
                tasks: [
                  {
                    name: "Ensure resource group exists",
                    "azure.azcollection.azure_rm_resourcegroup": {
                      name: "{{ resource_group }}",
                      location: "{{ azure_location }}"
                    }
                  },
                  {
                    name: "Ensure virtual network exists",
                    "azure.azcollection.azure_rm_virtualnetwork": {
                      resource_group: "{{ resource_group }}",
                      name: "{{ resource_group }}-vnet",
                      address_prefixes: ["10.10.0.0/16"]
                    }
                  },
                  {
                    name: "Ensure subnet exists",
                    "azure.azcollection.azure_rm_subnet": {
                      resource_group: "{{ resource_group }}",
                      name: "{{ resource_group }}-subnet",
                      address_prefix: "10.10.1.0/24",
                      virtual_network: "{{ resource_group }}-vnet"
                    }
                  },
                  {
                    name: "Create public IP",
                    "azure.azcollection.azure_rm_publicipaddress": {
                      resource_group: "{{ resource_group }}",
                      allocation_method: "Static",
                      name: "{{ vm_name }}-pip"
                    }
                  },
                  {
                    name: "Create NIC",
                    "azure.azcollection.azure_rm_networkinterface": {
                      resource_group: "{{ resource_group }}",
                      name: "{{ vm_name }}-nic",
                      virtual_network: "{{ resource_group }}-vnet",
                      subnet: "{{ resource_group }}-subnet",
                      public_ip_name: "{{ vm_name }}-pip"
                    }
                  },
                  {
                    name: "Provision Azure VM",
                    "azure.azcollection.azure_rm_virtualmachine": {
                      resource_group: "{{ resource_group }}",
                      name: "{{ vm_name }}",
                      vm_size: "{{ vm_size }}",
                      admin_username: "{{ admin_username }}",
                      network_interfaces: ["{{ vm_name }}-nic"],
                      image: {
                        offer: "0001-com-ubuntu-server-focal",
                        publisher: "Canonical",
                        sku: "20_04-lts",
                        version: "latest"
                      }
                    }
                  }
                ]
              }
            ];
          }
        },
        storage_account: {
          label: "Create Storage Account & Container",
          description: "Create a storage account and a blob container.",
          inputs: [
            {
              id: "azure_location",
              label: "Azure location",
              control: "select",
              options: AZURE_LOCATIONS.map(l => ({ value: l, label: l })),
              default: "eastus",
              hint: "Region"
            },
            { id: "resource_group", label: "Resource group", type: "text", default: "rg-storage", hint: "RG name" },
            { id: "account_name", label: "Storage account name", type: "text", default: "courtarchive001", hint: "Must be globally unique" },
            { id: "container_name", label: "Container name", type: "text", default: "documents", hint: "Blob container" }
          ],
          buildPlay: (vals, hosts) => {
            return [
              {
                name: "Create Azure storage account & container",
                hosts,
                become: false,
                gather_facts: false,
                vars: {
                  azure_location: vals.azure_location,
                  resource_group: vals.resource_group,
                  account_name: vals.account_name,
                  container_name: vals.container_name
                },
                tasks: [
                  {
                    name: "Ensure resource group exists",
                    "azure.azcollection.azure_rm_resourcegroup": {
                      name: "{{ resource_group }}",
                      location: "{{ azure_location }}"
                    }
                  },
                  {
                    name: "Create storage account",
                    "azure.azcollection.azure_rm_storageaccount": {
                      resource_group: "{{ resource_group }}",
                      name: "{{ account_name }}",
                      location: "{{ azure_location }}",
                      account_type: "Standard_LRS"
                    }
                  },
                  {
                    name: "Create blob container",
                    "azure.azcollection.azure_rm_storageblob": {
                      resource_group: "{{ resource_group }}",
                      storage_account_name: "{{ account_name }}",
                      container: "{{ container_name }}",
                      type: "container"
                    }
                  }
                ]
              }
            ];
          }
        }
      }
    },

    gcp: {
      label: "Google Cloud Platform",
      scenarios: {
        gce_instance: {
          label: "Provision GCE VM",
          description: "Create a GCE instance in a specified project and zone.",
          inputs: [
            { id: "project_id", label: "Project ID", type: "text", default: "my-gcp-project", hint: "GCP project" },
            {
              id: "zone",
              label: "Zone",
              control: "select",
              options: GCP_ZONES.map(z => ({ value: z, label: z })),
              default: "us-central1-a",
              hint: "GCE zone"
            },
            { id: "instance_name", label: "Instance name", type: "text", default: "gce-ansible-01", hint: "VM name" },
            { id: "machine_type", label: "Machine type", type: "text", default: "e2-medium", hint: "e2-medium, n2-standard-2, etc." },
            { id: "image_family", label: "Image family", type: "text", default: "debian-11", hint: "debian-11, ubuntu-2004-lts, etc." },
            { id: "image_project", label: "Image project", type: "text", default: "debian-cloud", hint: "debian-cloud, ubuntu-os-cloud, etc." }
          ],
          buildPlay: (vals, hosts) => {
            return [
              {
                name: "Provision GCE instance",
                hosts,
                become: false,
                gather_facts: false,
                vars: {
                  gcp_project: vals.project_id,
                  gcp_zone: vals.zone,
                  instance_name: vals.instance_name,
                  machine_type: vals.machine_type,
                  image_family: vals.image_family,
                  image_project: vals.image_project
                },
                tasks: [
                  {
                    name: "Create GCE instance",
                    "google.cloud.gcp_compute_instance": {
                      name: "{{ instance_name }}",
                      project: "{{ gcp_project }}",
                      zone: "{{ gcp_zone }}",
                      machine_type: "{{ machine_type }}",
                      disks: [
                        {
                          auto_delete: true,
                          boot: true,
                          initialize_params: {
                            source_image: "projects/{{ image_project }}/global/images/family/{{ image_family }}"
                          }
                        }
                      ],
                      network_interfaces: [
                        {
                          network: "default",
                          access_configs: [{ name: "External NAT", type: "ONE_TO_ONE_NAT" }]
                        }
                      ]
                    }
                  }
                ]
              }
            ];
          }
        },
        gcs_bucket: {
          label: "Create GCS Bucket",
          description: "Create a Google Cloud Storage bucket.",
          inputs: [
            { id: "project_id", label: "Project ID", type: "text", default: "my-gcp-project", hint: "GCP project" },
            { id: "bucket_name", label: "Bucket name", type: "text", default: "court-archive-gcs", hint: "Globally unique" },
            { id: "location", label: "Location", type: "text", default: "US", hint: "US, EU, regional code, etc." }
          ],
          buildPlay: (vals, hosts) => {
            return [
              {
                name: "Create GCS bucket",
                hosts,
                become: false,
                gather_facts: false,
                vars: {
                  gcp_project: vals.project_id,
                  bucket_name: vals.bucket_name,
                  bucket_location: vals.location
                },
                tasks: [
                  {
                    name: "Create bucket",
                    "google.cloud.gcp_storage_bucket": {
                      name: "{{ bucket_name }}",
                      project: "{{ gcp_project }}",
                      location: "{{ bucket_location }}"
                    }
                  }
                ]
              }
            ];
          }
        }
      }
    },

    oci: {
      label: "Oracle Cloud Infrastructure (OCI)",
      scenarios: {
        compute_instance: {
          label: "Provision OCI compute instance",
          description: "Create an OCI compute instance in a given compartment and subnet.",
          inputs: [
            { id: "compartment_ocid", label: "Compartment OCID", type: "text", default: "ocid1.compartment.oc1..xxxxx", hint: "Target compartment" },
            { id: "availability_domain", label: "Availability Domain", type: "text", default: "AD-1", hint: "AD name (e.g. Uocm:US-ASHBURN-AD-1)" },
            { id: "subnet_ocid", label: "Subnet OCID", type: "text", default: "ocid1.subnet.oc1..xxxxx", hint: "Target subnet" },
            { id: "display_name", label: "Instance display name", type: "text", default: "oci-ansible-01", hint: "Human-friendly name" },
            { id: "shape", label: "Shape", type: "text", default: "VM.Standard.E4.Flex", hint: "Compute shape" },
            { id: "image_ocid", label: "Image OCID", type: "text", default: "ocid1.image.oc1..xxxxx", hint: "OS image" }
          ],
          buildPlay: (vals, hosts) => {
            return [
              {
                name: "Provision OCI compute instance",
                hosts,
                become: false,
                gather_facts: false,
                vars: {
                  compartment_ocid: vals.compartment_ocid,
                  availability_domain: vals.availability_domain,
                  subnet_ocid: vals.subnet_ocid,
                  display_name: vals.display_name,
                  shape: vals.shape,
                  image_ocid: vals.image_ocid
                },
                tasks: [
                  {
                    name: "Create compute instance",
                    "oracle.oci.oci_compute_instance": {
                      availability_domain: "{{ availability_domain }}",
                      compartment_id: "{{ compartment_ocid }}",
                      display_name: "{{ display_name }}",
                      shape: "{{ shape }}",
                      create_vnic_details: {
                        subnet_id: "{{ subnet_ocid }}"
                      },
                      source_details: {
                        source_type: "image",
                        image_id: "{{ image_ocid }}"
                      }
                    }
                  }
                ]
              }
            ];
          }
        }
      }
    },

    vmware: {
      label: "VMware vSphere",
      scenarios: {
        vmware_guest: {
          label: "Provision vSphere VM (vmware_guest)",
          description: "Clone and customize a VM from a template using community.vmware.vmware_guest.",
          inputs: [
            { id: "vcenter_hostname", label: "vCenter hostname", type: "text", default: "vcenter.example.com", hint: "FQDN or IP" },
            { id: "datacenter", label: "Datacenter name", type: "text", default: "Datacenter-1", hint: "Existing DC" },
            { id: "cluster", label: "Cluster name", type: "text", default: "Cluster-1", hint: "Target cluster" },
            { id: "template", label: "Template name", type: "text", default: "tmpl-linux-gold", hint: "Template to clone" },
            { id: "vm_name", label: "New VM name", type: "text", default: "vm-linux-01", hint: "Target VM name" },
            { id: "datastore", label: "Datastore name", type: "text", default: "Datastore-1", hint: "Target datastore" }
          ],
          buildPlay: (vals, hosts) => {
            return [
              {
                name: "Provision vSphere VM",
                hosts,
                become: false,
                gather_facts: false,
                vars: {
                  vcenter_hostname: vals.vcenter_hostname,
                  datacenter: vals.datacenter,
                  cluster: vals.cluster,
                  template: vals.template,
                  vm_name: vals.vm_name,
                  datastore: vals.datastore
                },
                tasks: [
                  {
                    name: "Clone VM from template",
                    "community.vmware.vmware_guest": {
                      hostname: "{{ vcenter_hostname }}",
                      validate_certs: false,
                      datacenter: "{{ datacenter }}",
                      cluster: "{{ cluster }}",
                      name: "{{ vm_name }}",
                      template: "{{ template }}",
                      datastore: "{{ datastore }}",
                      state: "poweredon",
                      wait_for_ip_address: true
                    }
                  }
                ]
              }
            ];
          }
        }
      }
    },

    linux: {
      label: "Generic Linux hosts",
      scenarios: {
        nginx_server: {
          label: "Configure NGINX web server",
          description: "Install NGINX, enable service, and deploy a simple index page.",
          inputs: [
            {
              id: "http_port",
              label: "HTTP port",
              type: "number",
              default: "80",
              hint: "e.g. 80, 8080"
            },
            {
              id: "index_message",
              label: "Index page message",
              type: "text",
              default: "Hello from Ansible",
              hint: "Simple banner text"
            }
          ],
          buildPlay: (vals, hosts) => {
            return [
              {
                name: "Configure NGINX web server",
                hosts,
                become: true,
                tasks: [
                  {
                    name: "Install NGINX",
                    "ansible.builtin.package": {
                      name: "nginx",
                      state: "present"
                    }
                  },
                  {
                    name: "Ensure NGINX running and enabled",
                    "ansible.builtin.service": {
                      name: "nginx",
                      state: "started",
                      enabled: true
                    }
                  },
                  {
                    name: "Deploy index page",
                    "ansible.builtin.copy": {
                      dest: "/usr/share/nginx/html/index.html",
                      mode: "0644",
                      content: `<html><body><h1>${vals.index_message}</h1></body></html>`
                    }
                  }
                ]
              }
            ];
          }
        },
        linux_patch: {
          label: "Apply Linux security updates",
          description: "Run package updates and reboot if required.",
          inputs: [
            {
              id: "reboot_if_needed",
              label: "Reboot if kernel updated",
              control: "select",
              options: BOOL_OPTIONS,
              default: "true",
              hint: "true / false"
            }
          ],
          buildPlay: (vals, hosts) => {
            return [
              {
                name: "Apply Linux security updates",
                hosts,
                become: true,
                vars: {
                  reboot_if_needed: vals.reboot_if_needed === "true"
                },
                tasks: [
                  {
                    name: "Update package cache",
                    "ansible.builtin.package": {
                      name: "*",
                      state: "latest"
                    }
                  },
                  {
                    name: "Check if reboot is required (Debian/Ubuntu)",
                    "ansible.builtin.stat": {
                      path: "/var/run/reboot-required"
                    },
                    register: "reboot_required_file",
                    when: "ansible_os_family == 'Debian'"
                  },
                  {
                    name: "Reboot if needed",
                    "ansible.builtin.reboot": {},
                    when: "reboot_if_needed and reboot_required_file.stat.exists | default(false)"
                  }
                ]
              }
            ];
          }
        },
        linux_users: {
          label: "Create Linux users & groups",
          description: "Manage local users, groups and SSH keys.",
          inputs: [
            { id: "group_name", label: "Group name", type: "text", default: "appusers", hint: "Primary group" },
            { id: "username", label: "User name", type: "text", default: "deploy", hint: "Login user" },
            {
              id: "shell",
              label: "Shell",
              control: "select",
              options: [
                { value: "/bin/bash", label: "/bin/bash" },
                { value: "/bin/zsh", label: "/bin/zsh" },
                { value: "/bin/sh", label: "/bin/sh" }
              ],
              default: "/bin/bash",
              hint: "Default shell"
            },
            { id: "ssh_pubkey", label: "SSH public key", type: "text", default: "ssh-ed25519 AAAA...", hint: "User key" }
          ],
          buildPlay: (vals, hosts) => {
            return [
              {
                name: "Create Linux users & groups",
                hosts,
                become: true,
                vars: {
                  group_name: vals.group_name,
                  username: vals.username,
                  user_shell: vals.shell,
                  ssh_pubkey: vals.ssh_pubkey
                },
                tasks: [
                  {
                    name: "Ensure group exists",
                    "ansible.builtin.group": {
                      name: "{{ group_name }}",
                      state: "present"
                    }
                  },
                  {
                    name: "Ensure user exists",
                    "ansible.builtin.user": {
                      name: "{{ username }}",
                      group: "{{ group_name }}",
                      shell: "{{ user_shell }}",
                      create_home: true
                    }
                  },
                  {
                    name: "Install authorized key",
                    "ansible.posix.authorized_key": {
                      user: "{{ username }}",
                      state: "present",
                      key: "{{ ssh_pubkey }}"
                    }
                  }
                ]
              }
            ];
          }
        }
      }
    },

    windows: {
      label: "Generic Windows hosts",
      scenarios: {
        join_domain: {
          label: "Join Windows server to AD domain",
          description: "Join a Windows host to an Active Directory domain using win_domain_membership.",
          inputs: [
            { id: "domain_name", label: "Domain name", type: "text", default: "corp.example.com", hint: "FQDN" },
            { id: "ou_path", label: "OU path (optional)", type: "text", default: "OU=Servers,DC=corp,DC=example,DC=com", hint: "Can be blank" },
            { id: "domain_user", label: "Domain join user (UPN)", type: "text", default: "ansible-join@corp.example.com", hint: "UPN format" },
            {
              id: "reboot_after",
              label: "Reboot after join",
              control: "select",
              options: BOOL_OPTIONS,
              default: "true",
              hint: "true / false"
            }
          ],
          buildPlay: (vals, hosts) => {
            return [
              {
                name: "Join Windows servers to domain",
                hosts,
                gather_facts: false,
                vars: {
                  domain_name: vals.domain_name,
                  ou_path: vals.ou_path,
                  domain_user: vals.domain_user,
                  reboot_after: vals.reboot_after === "true"
                },
                tasks: [
                  {
                    name: "Join domain",
                    "ansible.windows.win_domain_membership": {
                      dns_domain_name: "{{ domain_name }}",
                      domain_admin_user: "{{ domain_user }}",
                      domain_admin_password: "{{ domain_join_password | default('CHANGEME') }}",
                      domain_ou_path: "{{ ou_path }}",
                      state: "domain"
                    },
                    register: "domain_state"
                  },
                  {
                    name: "Reboot if domain join changed and reboot_after is true",
                    "ansible.windows.win_reboot": {},
                    when: "reboot_after and domain_state.reboot_required"
                  }
                ]
              }
            ];
          }
        },
        install_iis: {
          label: "Install IIS web server",
          description: "Enable IIS role and deploy a simple default page.",
          inputs: [
            { id: "site_name", label: "Site name", type: "text", default: "Default Web Site", hint: "IIS site" },
            { id: "index_message", label: "Index page message", type: "text", default: "Hello from Ansible on IIS", hint: "HTML content heading" }
          ],
          buildPlay: (vals, hosts) => {
            return [
              {
                name: "Install IIS",
                hosts,
                gather_facts: false,
                tasks: [
                  {
                    name: "Install IIS role",
                    "ansible.windows.win_feature": {
                      name: "Web-Server",
                      state: "present",
                      include_management_tools: true
                    }
                  },
                  {
                    name: "Ensure IIS service running",
                    "ansible.windows.win_service": {
                      name: "W3SVC",
                      state: "started",
                      start_mode: "auto"
                    }
                  },
                  {
                    name: "Deploy default page",
                    "ansible.windows.win_copy": {
                      dest: "C:\\inetpub\\wwwroot\\index.html",
                      content: `<html><body><h1>${vals.index_message}</h1></body></html>`
                    }
                  }
                ]
              }
            ];
          }
        }
      }
    }
  };

  // -----------------------
  // Simple YAML serializer (for our limited structures)
  // -----------------------
  function toYaml(value, indent = 0) {
    const pad = "  ".repeat(indent);

    if (value === null || value === undefined) {
      return "null";
    }
    if (typeof value === "string") {
      // Quote only when needed
      if (/[:{}\[\],&*#?|<>=!%@`\\]/.test(value) || value.trim() !== value || value.includes("\n")) {
        return JSON.stringify(value);
      }
      return value;
    }
    if (typeof value === "number" || typeof value === "boolean") {
      return String(value);
    }
    if (Array.isArray(value)) {
      if (value.length === 0) return "[]";
      return value
        .map(item => pad + "- " + toYaml(item, indent + 1).replace(/^\s+/, ""))
        .join("\n");
    }
    if (typeof value === "object") {
      const keys = Object.keys(value);
      if (keys.length === 0) return "{}";
      return keys
        .map(key => {
          const v = value[key];
          const keyStr = String(key);
          if (
            v === null ||
            typeof v === "string" ||
            typeof v === "number" ||
            typeof v === "boolean"
          ) {
            return pad + keyStr + ": " + toYaml(v, indent + 1);
          } else {
            const nested = toYaml(v, indent + 1);
            return pad + keyStr + ":\n" + nested;
          }
        })
        .join("\n");
    }
    return JSON.stringify(value);
  }

  // -----------------------
  // UI wiring
  // -----------------------
  const platformSelect = document.getElementById("platformSelect");
  const scenarioSelect = document.getElementById("scenarioSelect");
  const paramsArea = document.getElementById("paramsArea");
  const generateButton = document.getElementById("generateButton");
  const resetButton = document.getElementById("resetButton");
  const formatToggle = document.getElementById("formatToggle");
  const outputPre = document.getElementById("outputPre");
  const codeMeta = document.getElementById("codeMeta");
  const filenameInput = document.getElementById("filenameInput");
  const hostsInput = document.getElementById("hostsInput");
  const downloadButton = document.getElementById("downloadButton");
  const copyButton = document.getElementById("copyButton");
  const copyCommandButton = document.getElementById("copyCommandButton");
  const commandHint = document.getElementById("commandHint");
  const statusLine = document.getElementById("statusLine");

  let currentFormat = "yaml";

  function initSelectors() {
    platformSelect.innerHTML = "";
    Object.entries(SCENARIO_DEFS).forEach(([id, def]) => {
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = def.label;
      platformSelect.appendChild(opt);
    });
    loadScenariosForPlatform(platformSelect.value);
  }

  function loadScenariosForPlatform(platformId) {
    const platform = SCENARIO_DEFS[platformId];
    scenarioSelect.innerHTML = "";
    if (!platform) return;
    Object.entries(platform.scenarios).forEach(([id, sc]) => {
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = sc.label;
      scenarioSelect.appendChild(opt);
    });
    renderParams(platformId, scenarioSelect.value);
  }

  function renderParams(platformId, scenarioId) {
    const platform = SCENARIO_DEFS[platformId];
    const scenario = platform && platform.scenarios[scenarioId];
    paramsArea.innerHTML = "";
    if (!scenario) return;

    const desc = document.createElement("p");
    desc.className = "hint";
    desc.textContent = scenario.description || "";
    paramsArea.appendChild(desc);

    scenario.inputs.forEach(input => {
      const field = document.createElement("div");
      field.className = "field";

      const labelRow = document.createElement("div");
      labelRow.className = "field-label-row";

      const label = document.createElement("label");
      label.htmlFor = input.id;
      label.textContent = input.label;

      const hintSpan = document.createElement("span");
      hintSpan.className = "hint";
      hintSpan.textContent = input.hint || "";

      labelRow.appendChild(label);
      labelRow.appendChild(hintSpan);
      field.appendChild(labelRow);

      // if control: "select" use dropdown
      if (input.control === "select" && Array.isArray(input.options)) {
        const selectEl = document.createElement("select");
        selectEl.id = input.id;
        input.options.forEach(optDef => {
          const opt = document.createElement("option");
          opt.value = optDef.value;
          opt.textContent = optDef.label;
          selectEl.appendChild(opt);
        });
        if (input.default) {
          selectEl.value = input.default;
        }
        field.appendChild(selectEl);
      } else {
        const inputEl = document.createElement("input");
        inputEl.type = input.type || "text";
        inputEl.id = input.id;
        inputEl.value = input.default || "";
        field.appendChild(inputEl);
      }

      paramsArea.appendChild(field);
    });
  }

  function collectValues(platformId, scenarioId) {
    const platform = SCENARIO_DEFS[platformId];
    const scenario = platform && platform.scenarios[scenarioId];
    const values = {};
    if (!scenario) return values;
    scenario.inputs.forEach(input => {
      const el = document.getElementById(input.id);
      values[input.id] = el ? el.value : "";
    });
    return values;
  }

  function safeUpdateStatus(ok, msg) {
    const dot = statusLine.querySelector(".status-dot");
    const textNode = statusLine.querySelector("span:nth-child(2)");
    if (!dot || !textNode) return;
    dot.classList.toggle("error", !ok);
    textNode.textContent = msg;
    if (!ok) {
      textNode.classList.add("error-text");
    } else {
      textNode.classList.remove("error-text");
    }
  }

  function generatePlaybook() {
    const platformId = platformSelect.value;
    const scenarioId = scenarioSelect.value;
    const hosts = hostsInput.value || "all";
    const platform = SCENARIO_DEFS[platformId];
    const scenario = platform && platform.scenarios[scenarioId];

    if (!scenario) {
      outputPre.textContent = "# No scenario selected.";
      safeUpdateStatus(false, "No scenario selected.");
      return;
    }

    const vals = collectValues(platformId, scenarioId);
    let playbook;
    try {
      playbook = scenario.buildPlay(vals, hosts);
    } catch (e) {
      outputPre.textContent = "# Error building playbook: " + e.message;
      safeUpdateStatus(false, "Error building playbook. Check console.");
      console.error("buildPlay error", e);
      return;
    }

    let text;
    if (currentFormat === "json") {
      text = JSON.stringify(playbook, null, 2);
    } else {
      text = toYaml(playbook, 0);
    }
    outputPre.textContent = text;

    const filename = filenameInput.value || "playbook_generated.yml";
    commandHint.textContent = `ansible-playbook -i inventory.yml ${filename}`;
    codeMeta.textContent = `${platform.label} ¬∑ ${scenario.label} ¬∑ Format: ${currentFormat.toUpperCase()}`;
    safeUpdateStatus(true, "Playbook generated successfully.");
  }

  function handleDownload() {
    const filename = filenameInput.value || (currentFormat === "yaml" ? "playbook_generated.yml" : "playbook_generated.json");
    const blob = new Blob([outputPre.textContent], {
      type: currentFormat === "yaml" ? "text/yaml" : "application/json"
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function handleCopyCode() {
    navigator.clipboard.writeText(outputPre.textContent).then(() => {
      safeUpdateStatus(true, "Playbook copied to clipboard.");
    }).catch(() => {
      safeUpdateStatus(false, "Unable to copy playbook.");
    });
  }

  function handleCopyCommand() {
    navigator.clipboard.writeText(commandHint.textContent).then(() => {
      safeUpdateStatus(true, "Command copied to clipboard.");
    }).catch(() => {
      safeUpdateStatus(false, "Unable to copy command.");
    });
  }

  function handleFormatToggle(ev) {
    const btn = ev.target.closest("button[data-format]");
    if (!btn) return;
    const fmt = btn.getAttribute("data-format");
    if (!fmt || fmt === currentFormat) return;
    currentFormat = fmt;
    Array.from(formatToggle.querySelectorAll("button[data-format]")).forEach(b => {
      b.classList.toggle("active", b.getAttribute("data-format") === currentFormat);
    });
    // Regenerate with new format if code exists
    generatePlaybook();
  }

  function resetAll() {
    hostsInput.value = "all";
    filenameInput.value = "playbook_generated.yml";
    initSelectors();
    outputPre.textContent = "# Select a platform & scenario, adjust parameters, then click ‚ÄúGenerate Playbook‚Äù.";
    commandHint.textContent = "ansible-playbook -i inventory.yml playbook_generated.yml";
    codeMeta.textContent = "Waiting for input‚Ä¶";
    safeUpdateStatus(true, "Reset to defaults.");
  }

  // init
  document.addEventListener("DOMContentLoaded", () => {
    initSelectors();
    generateButton.addEventListener("click", generatePlaybook);
    resetButton.addEventListener("click", resetAll);
    platformSelect.addEventListener("change", () => {
      loadScenariosForPlatform(platformSelect.value);
      safeUpdateStatus(true, "Platform changed; scenario & parameters updated.");
    });
    scenarioSelect.addEventListener("change", () => {
      renderParams(platformSelect.value, scenarioSelect.value);
      safeUpdateStatus(true, "Scenario changed; review parameters.");
    });
    formatToggle.addEventListener("click", handleFormatToggle);
    downloadButton.addEventListener("click", handleDownload);
    copyButton.addEventListener("click", handleCopyCode);
    copyCommandButton.addEventListener("click", handleCopyCommand);
  });
</script>
</body>
</html>
